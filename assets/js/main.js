layui.define(["jquery","ztree.edit","bootstrap","table","wulaui"],function(e){var t=layui.$,a=layui.wulaui,i=layui.table;e("cms.main",{cmToolbar:null,chBtns:null,editable:0,cNode:null,cModel:null,editURL:null,deleteURL:null,restoreURL:null,newUrl:null,pubURL:null,dataURL:null,ccUrl:null,pubChBtn:null,delChBtn:null,restoreChBtn:null,cntGrid:null,gridCols:null,sortf:null,searchParams:{status:11},init:function(e,n){var s=this;t("#cms-site-page").removeClass("hidden"),this.editable=e,this.gridCols=n,this.sortf=new a.map,t("#channel-tree").on("ztree.init",function(e){t.extend(!0,e.tree,{settings:s._configTree()})}).wulatree("load"),this.newUrl=a.app("cms/site/page/add/"),this.editURL=a.app("cms/site/page/edit/"),this.deleteURL=a.app("cms/site/page/delch/"),this.restoreURL=a.app("cms/site/page/restorech/"),this.pubURL=a.app("cms/site/page/publishch/"),this.ccUrl=a.app("cms/site/cache/clear/"),this.dataURL=a.app("cms/site/data"),this.cmToolbar=t("#cms-toolbar"),this.pubChBtn=t("#pub-ch"),this.delChBtn=t("#delete-ch"),this.restoreChBtn=t("#restore-ch"),this.chBtns=t("#ch-btns"),this.chBtns.find("li").not(".showx").hide(),this.cmToolbar.find(".ps").not(".s11").hide(),this.pubChBtn.on("ajax.success",function(){var e=t.fn.zTree.getZTreeObj("channel-tree");if(s.cNode){var a=e.getNodeByParam("id",s.cNode.id);a.status=1,a.name=t(a.name).text(),e.updateNode(a),s.showBtns(a)}}),this.delChBtn.on("ajax.success",function(){s._reloadTree()}),this.restoreChBtn.on("ajax.success",function(){s._reloadTree(1)}),t("#ch-status a").on("click",function(){var e=t(this).data("status"),a=t(this).find("i").attr("class"),i=t(this).text().trim();t("#reload-ch").find("i").attr("class",a),t("#ch-box").text("["+i+"]"),s.cmToolbar.find(".ps").hide(),s.cmToolbar.find(".s"+e).show(),s.searchParams.status=e,s.reload(s.cNode,s.cModel)}),t("body").on("click","#view-content a",function(){s.cModel=t(this).data("modelData"),s.reload(s.cNode,s.cModel)}).on("ajax.before","a[lay-event]",function(){var e=t(this).data("curpage"),i=e.event,n=e.data;if("edit"===i&&2===n.status)return a.toast.warning("不能编辑回收站里的内容"),!1}).on("click","#m-name",function(){s.reload(s.cNode,s.cModel)}),t("#btn-restore").on("click",function(){var e=i.checkStatus("grid"),n=[];e.data.length>0?(t(e.data).each(function(e,t){2===t.status&&n.push(t.page_id)}),n.length>0&&a.ajax.confirm({url:a.app("cms/site/page/restore"),element:t(this),data:{ids:n.join(",")}},"你真要从回收站还原所选内容吗?",{loading:!0})):a.toast.warning("请选择要还原的内容")}),t("#btn-unpub").on("click",function(){var e=i.checkStatus("grid"),n=[];e.data.length>0?(t(e.data).each(function(e,t){1===t.status&&n.push(t.page_id)}),n.length>0&&a.ajax.confirm({url:a.app("cms/site/page/unpub"),element:t(this),data:{ids:n.join(",")}},"你真要将所选内容下线吗?",{loading:!0})):a.toast.warning("请选择要下线的内容")}),t("#btn-pending").on("click",function(){var e=i.checkStatus("grid"),n=[];e.data.length>0?(t(e.data).each(function(e,t){0===t.revStatus&&n.push(t.page_id)}),n.length>0&&a.ajax.confirm({url:a.app("cms/site/page/pending"),element:t(this),data:{ids:n.join(",")}},"你真要将所选内容提交审核吗?",{loading:!0})):a.toast.warning("请选择要送审的内容")}),t("#btn-publish").on("click",function(){var e=i.checkStatus("grid"),n=[];e.data.length>0?(t(e.data).each(function(e,t){1===t.revStatus&&n.push(t.page_id+","+t.ver)}),n.length>0&&a.ajax.confirm({url:a.app("cms/site/page/publish"),element:t(this),data:{ids:n.join(",")}},"你真要发布所选内容吗?",{loading:!0})):a.toast.warning("请选择要发布的内容")}),t("#btn-nopub").on("click",function(){var e=i.checkStatus("grid"),n=[];e.data.length>0?(t(e.data).each(function(e,t){1===t.revStatus&&n.push(t.page_id+","+t.ver)}),n.length>0&&a.ajax.confirm({url:a.app("cms/site/page/nopublish"),element:t(this),data:{ids:n.join(",")}},"你真要驳回所选内容吗?",{loading:!0})):a.toast.warning("请选择要驳回的内容")}),t("#searchq").on("submit",function(){return s.searchParams.q=t(this).find("input").val(),s.reload(s.cNode,s.cModel),!1}),t("#content-grid").data("loaderObj",{reload:function(){s.cntGrid.reload()}}),s.cntGrid=i.render({id:"grid",elem:"#content-grid",cols:[[]],skin:"line",height:"full-50",method:"post",cellMinWidth:60,page:!0,limit:20,limits:[10,20,30,40,50],text:{none:"无数据啊"}}),i.on("sort(grid)",function(e){if(e.type)s.sortf.put(e.field,"desc"===e.type?"d":"a");else{s.sortf.remove(e.field);var t=s.sortf.element(0);t&&(e.field=t.key,e.type="d"===t.value?"desc":"asc")}var a=s.sortf.join(",");s.searchParams.sort={name:a.keys,dir:a.values},s.cntGrid.reload({where:s.searchParams,initSort:e})}),i.on("tool(grid)",function(e){var a=t(e.tr[e.tr.length-1]).find('a[lay-event="'+e.event+'"]'),i=e.data,n="";if(a.length>0){var s=a.data("ogurl");s||(s=a.attr("href"),a.data("ogurl",s)),s+=i.page_id,"del"===e.event?2===i.status?(s+="/1",a.data("confirm","你真的要将其永久删除吗?")):i.revStatus<3?(s+="/0/"+i.ver,a.data("confirm","你真的要删除这个版本?")):a.data("confirm","你真的要将其放入回收站吗?"):i.revStatus<3&&(s+="/"+i.ver,n=",rev:"+i.ver),a.data("curpage",e),a.attr("href",s),void 0!==a.data("tab")&&a.data("title")&&a.data("title",a.data("title").replace("{page_id}","ID:"+i.page_id+n))}})},reload:function(e,a){if(e&&e.models.length>0){var i=a||e.models[e.models.length-1],n=this.gridCols[i.refid]?this.gridCols[i.refid]:[];t("#m-name").html(i.name),this.sortf.clear(),this.searchParams.chid=e.id,this.searchParams.mid=i.refid,this.searchParams.sort={name:"page_id",dir:"d"},this.sortf.put("page_id","d");var s={url:this.dataURL,where:this.searchParams,page:{curr:1},initSort:{field:"page_id",type:"desc"}};s.cols=n,this.cntGrid.reload(s)}else this.searchParams.chid=0,this.searchParams.mid=0,this.sortf.clear(),delete this.searchParams.sort,this.cntGrid.reload({url:this.dataURL,where:this.searchParams,cols:[],page:!1})},createNewBtns:function(e){var a=t("#new-content"),i=t("#view-content"),n=i.closest("div"),s=this;t("#add-sub-btn").attr("href",this.newUrl+"1/"+this.cNode.id).attr("title","添加『"+this.cNode.name+"』子栏目").parent().show(),t("#edit-ch").attr("href",this.editURL+s.cNode.id).attr("title","修改栏目『"+s.cNode.name+"』").parent().show(),n.hide(),a.find(".cm").empty(),i.find(".cm").empty(),e.length>0&&(t(e).each(function(e,n){n.enabled&&a.prepend('<li class="cm"><a href="'+s.newUrl+n.id+"/"+s.cNode.id+'" data-tab="&#xe649;" data-title="新增『'+n.name+'』"><i class="fa fa-plus-square-o text-success"></i> '+n.name+"</a></li>");var r=t('<li class="cm"><a href="javascript:">'+n.name+"</a></li>");r.find("a").data("modelData",n),i.prepend(r)}),n.show()),this.delChBtn.attr("href",this.deleteURL+s.cNode.id),this.restoreChBtn.attr("href",this.restoreURL+s.cNode.id),t("#cc-ch").attr("href",this.ccUrl+s.cNode.id),t("#cc-ch-all").attr("href",this.ccUrl+s.cNode.id+"/1"),this.pubChBtn.find("a").attr("href",this.pubURL+s.cNode.id+"/1")},moveCh:function(e,i,n,s){var r=i[0],d=r.id,o=r.fromNode,c=o?o.id:0,l=n.id,h=n.id,u=t.fn.zTree.getZTreeObj(e);if("inner"!==s){var f=n.getParentNode();l=f?f.id:0}return a.ajax.get(a.app("cms/site/channel/move/"),{cid:d,oid:c,nid:l,tid:h,type:s}).done(function(e){200===e.code&&(r.channel=l,u.updateNode(r),u.moveNode(n,r,s))}),!1},showBtns:function(e){var a=this;if(a.cmToolbar.addClass("hidden"),a.cmToolbar.find(".act").hide(),a.chBtns.find(".act").hide(),e){t("#ch-name").html(e.name);var i=".btn"+e.status;a.chBtns.find(i).show(),e.models.length>0&&(a.cmToolbar.find(i).show(),a.cmToolbar.removeClass("hidden"))}else a.cNode=null,t("#ch-name").html("我的网站"),a.chBtns.find(".showx").show();a.reload(e)},_reloadTree:function(e){var a=t.fn.zTree.getZTreeObj("channel-tree");if(this.cNode){var i=this.cNode.getParentNode();if(1===e)for(;i&&2===i.status;)i=i.getParentNode();else 2===e&&(i=null);a.reAsyncChildNodes(i,"refresh")}else a.reAsyncChildNodes(null,"refresh")},_configTree:function(){var e=this;return{view:{showLine:!0,nameIsHTML:!0,showTitle:!1,selectedMulti:!1},data:{keep:{leaf:!1,parent:!0}},edit:{enable:e.editable,showRemoveBtn:!1,showRenameBtn:!1},callback:{onClick:function(t,a,i){return e.cNode=i,e.createNewBtns(i.models),e.showBtns(i),e.cNode&&(e.cNode.id,i.id),!1},onAsyncSuccess:function(a,i){if(e.cNode){var n=t.fn.zTree.getZTreeObj(i).getNodeByParam("id",e.cNode.id);e.showBtns(n)}else e.showBtns()},beforeDrop:function(t,i,n,s){var r=n;if(i[0].fromNode=i[0].getParentNode(),"inner"===s){if(1!==n.status)return a.toast.warning("无法将栏目移动到回收站里的栏目"),!1;if(2===i[0].status)return a.toast.warning("无法移动回收站里的栏目"),!1}else{if(i[0].channel===n.channel)return e.moveCh(t,i,n,s);r=n.getParentNode()}if(r){if(confirm("你真的要将栏目『"+i[0].name+"』移动到『"+r.name+"』吗?"))return e.moveCh(t,i,n,s)}else if(confirm("你真的要将栏目『"+i[0].name+"』变为顶级栏目吗?"))return e.moveCh(t,i,n,s);return!1}}}}})});