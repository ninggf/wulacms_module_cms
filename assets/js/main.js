layui.define(["jquery","ztree.edit","bootstrap","table","wulaui"],function(e){var u=layui.$,f=layui.wulaui,i=layui.table;e("cms.main",{cmToolbar:null,chBtns:null,editable:0,cNode:null,cModel:null,editURL:null,deleteURL:null,restoreURL:null,newUrl:null,pubURL:null,dataURL:null,ccUrl:null,pubChBtn:null,delChBtn:null,restoreChBtn:null,cntGrid:null,gridCols:null,sortf:null,searchParams:{status:11},init:function(e,t){var a=u("#cms-site-page"),n=this;a.removeClass("hidden"),this.editable=e,this.gridCols=t,this.sortf=new f.map,u("#channel-tree").on("ztree.init",function(e){u.extend(!0,e.tree,{settings:n._configTree()})}).wulatree("load"),this.newUrl=f.app("cms/site/page/add/"),this.editURL=f.app("cms/site/page/edit/"),this.deleteURL=f.app("cms/site/page/delch/"),this.restoreURL=f.app("cms/site/page/restorech/"),this.pubURL=f.app("cms/site/page/publishch/"),this.ccUrl=f.app("cms/site/cache/clear/"),this.dataURL=f.app("cms/site/data"),this.cmToolbar=u("#cms-toolbar"),this.pubChBtn=u("#pub-ch"),this.delChBtn=u("#delete-ch"),this.restoreChBtn=u("#restore-ch"),this.chBtns=u("#ch-btns"),this.chBtns.find("li").not(".showx").hide(),this.cmToolbar.find(".ps").not(".s11").hide(),this.pubChBtn.on("ajax.success",function(){var e=u.fn.zTree.getZTreeObj("channel-tree");if(n.cNode){var t=e.getNodeByParam("id",n.cNode.id);t.status=1,t.name=u(t.name).text(),e.updateNode(t),n.showBtns(t)}}),this.delChBtn.on("ajax.success",function(){n._reloadTree()}),this.restoreChBtn.on("ajax.success",function(){n._reloadTree(1)}),u("#ch-status a").on("click",function(){var e=u(this).data("status"),t=u(this).find("i").attr("class"),a=u(this).text().trim();u("#reload-ch").find("i").attr("class",t),u("#ch-box").text("["+a+"]"),n.cmToolbar.find(".ps").hide(),n.cmToolbar.find(".s"+e).show(),n.searchParams.status=e,n.reload(n.cNode,n.cModel)}),u("body").on("click","#view-content a",function(){n.cModel=u(this).data("modelData"),n.reload(n.cNode,n.cModel)}).on("ajax.before","a[lay-event]",function(){var e=u(this).data("curpage"),t=e.event,a=e.data;if("edit"===t&&2===a.status)return f.toast.warning("不能编辑回收站里的内容"),!1}).on("click","#m-name",function(){n.reload(n.cNode,n.cModel)}),u("#btn-restore").on("click",function(){var e=i.checkStatus("grid"),a=[];0<e.data.length?(u(e.data).each(function(e,t){2===t.status&&a.push(t.page_id)}),0<a.length&&f.ajax.confirm({url:f.app("cms/site/page/restore"),element:u(this),data:{ids:a.join(",")}},"你真要从回收站还原所选内容吗?",{loading:!0})):f.toast.warning("请选择要还原的内容")}),u("#btn-ccache").on("click",function(){var e=i.checkStatus("grid"),a=[];0<e.data.length?(u(e.data).each(function(e,t){a.push(t.page_id)}),0<a.length&&f.ajax.confirm({url:f.app("cms/site/cache/clear"),element:u(this),data:{ids:a.join(",")}},"你真要清空所选内容的缓存吗?",{loading:!0})):f.toast.warning("请选择要清空缓存的内容")}),u("#btn-unpub").on("click",function(){var e=i.checkStatus("grid"),a=[];0<e.data.length?(u(e.data).each(function(e,t){1===t.status&&a.push(t.page_id)}),0<a.length&&f.ajax.confirm({url:f.app("cms/site/page/unpub"),element:u(this),data:{ids:a.join(",")}},"你真要将所选内容下线吗?",{loading:!0})):f.toast.warning("请选择要下线的内容")}),u("#btn-pending").on("click",function(){var e=i.checkStatus("grid"),a=[];0<e.data.length?(u(e.data).each(function(e,t){0===t.revStatus&&a.push(t.page_id)}),0<a.length&&f.ajax.confirm({url:f.app("cms/site/page/pending"),element:u(this),data:{ids:a.join(",")}},"你真要将所选内容提交审核吗?",{loading:!0})):f.toast.warning("请选择要送审的内容")}),u("#btn-publish").on("click",function(){var e=i.checkStatus("grid"),a=[];0<e.data.length?(u(e.data).each(function(e,t){1===t.revStatus&&a.push(t.page_id+","+t.ver)}),0<a.length&&f.ajax.confirm({url:f.app("cms/site/page/publish"),element:u(this),data:{ids:a.join(",")}},"你真要发布所选内容吗?",{loading:!0})):f.toast.warning("请选择要发布的内容")}),u("#btn-nopub").on("click",function(){var e=i.checkStatus("grid"),a=[];0<e.data.length?(u(e.data).each(function(e,t){1===t.revStatus&&a.push(t.page_id+","+t.ver)}),0<a.length&&f.ajax.confirm({url:f.app("cms/site/page/nopublish"),element:u(this),data:{ids:a.join(",")}},"你真要驳回所选内容吗?",{loading:!0})):f.toast.warning("请选择要驳回的内容")}),u("#searchq").on("submit",function(){return n.searchParams.q=u(this).find("input").val(),n.reload(n.cNode,n.cModel),!1}),u("#content-grid").data("loaderObj",{reload:function(){n.cntGrid.reload()}}),n.cntGrid=i.render({id:"grid",elem:"#content-grid",cols:[[]],skin:"line",height:"full-50",method:"post",cellMinWidth:60,page:!0,limit:20,limits:[10,20,30,40,50],text:{none:"无数据啊"}}),i.on("sort(grid)",function(e){if(e.type)n.sortf.put(e.field,"desc"===e.type?"d":"a");else{n.sortf.remove(e.field);var t=n.sortf.element(0);t&&(e.field=t.key,e.type="d"===t.value?"desc":"asc")}var a=n.sortf.join(",");n.searchParams.sort={name:a.keys,dir:a.values},n.cntGrid.reload({where:n.searchParams,initSort:e})}),i.on("tool(grid)",function(e){var t=u(e.tr[e.tr.length-1]).find('a[lay-event="'+e.event+'"]'),a=e.data,n="";if(0<t.length){var i=t.data("ogurl");i||(i=t.attr("href"),t.data("ogurl",i)),i+=a.page_id,"del"===e.event?2===a.status?(i+="/1",t.data("confirm","你真的要将其永久删除吗?")):a.revStatus<3?(i+="/0/"+a.ver,t.data("confirm","你真的要删除这个版本?")):t.data("confirm","你真的要将其放入回收站吗?"):a.revStatus<3&&(i+="/"+a.ver,n=",rev:"+a.ver),t.data("curpage",e),t.attr("href",i),void 0!==t.data("tab")&&t.data("title")&&t.data("title",t.data("title").replace("{page_id}","ID:"+a.page_id+n))}})},reload:function(e,t){if(e&&0<e.models.length){var a=t||e.models[e.models.length-1],n=this.gridCols[a.refid]?this.gridCols[a.refid]:[];u("#m-name").html(a.name),this.sortf.clear(),this.searchParams.chid=e.id,this.searchParams.mid=a.refid,this.searchParams.sort={name:"page_id",dir:"d"},this.sortf.put("page_id","d");var i={url:this.dataURL,where:this.searchParams,page:{curr:1},initSort:{field:"page_id",type:"desc"}};i.cols=n,this.cntGrid.reload(i)}else this.searchParams.chid=0,this.searchParams.mid=0,this.sortf.clear(),delete this.searchParams.sort,this.cntGrid.reload({url:this.dataURL,where:this.searchParams,cols:[],page:!1})},createNewBtns:function(e){var n=u("#new-content"),i=u("#view-content"),t=i.closest("div"),s=this;u("#add-sub-btn").attr("href",this.newUrl+"1/"+this.cNode.id).attr("title","添加『"+this.cNode.name+"』子栏目").parent().show(),u("#edit-ch").attr("href",this.editURL+s.cNode.id).attr("title","修改栏目『"+s.cNode.name+"』").parent().show(),t.hide(),n.find(".cm").empty(),i.find(".cm").empty(),0<e.length&&(u(e).each(function(e,t){t.enabled&&n.prepend('<li class="cm"><a href="'+s.newUrl+t.id+"/"+s.cNode.id+'" data-tab="&#xe649;" data-title="新增『'+t.name+'』"><i class="fa fa-plus-square-o text-success"></i> '+t.name+"</a></li>");var a=u('<li class="cm"><a href="javascript:">'+t.name+"</a></li>");a.find("a").data("modelData",t),i.prepend(a)}),t.show()),this.delChBtn.attr("href",this.deleteURL+s.cNode.id),this.restoreChBtn.attr("href",this.restoreURL+s.cNode.id),u("#cc-ch").attr("href",this.ccUrl+s.cNode.id),u("#cc-ch-all").attr("href",this.ccUrl+s.cNode.id+"/1"),this.pubChBtn.find("a").attr("href",this.pubURL+s.cNode.id+"/1")},moveCh:function(e,t,a,n){var i=t[0],s=i.id,r=i.fromNode,d=r?r.id:0,o=a.id,c=a.id,l=u.fn.zTree.getZTreeObj(e);if("inner"!==n){var h=a.getParentNode();o=h?h.id:0}return f.ajax.get(f.app("cms/site/channel/move/"),{cid:s,oid:d,nid:o,tid:c,type:n}).done(function(e){200===e.code&&(i.channel=o,l.updateNode(i),l.moveNode(a,i,n))}),!1},showBtns:function(e){var t=this;if(t.cmToolbar.addClass("hidden"),t.cmToolbar.find(".act").hide(),t.chBtns.find(".act").hide(),e){u("#ch-name").html(e.name);var a=".btn"+e.status;t.chBtns.find(a).show(),0<e.models.length&&(t.cmToolbar.find(a).show(),t.cmToolbar.removeClass("hidden"))}else t.cNode=null,u("#ch-name").html("我的网站"),t.chBtns.find(".showx").show();t.reload(e)},_reloadTree:function(e){var t=u.fn.zTree.getZTreeObj("channel-tree");if(this.cNode){var a=this.cNode.getParentNode();if(1===e)for(;a&&2===a.status;)a=a.getParentNode();else 2===e&&(a=null);t.reAsyncChildNodes(a,"refresh")}else t.reAsyncChildNodes(null,"refresh")},_configTree:function(){var s=this;return{view:{showLine:!0,nameIsHTML:!0,showTitle:!1,selectedMulti:!1},data:{keep:{leaf:!1,parent:!0}},edit:{enable:s.editable,showRemoveBtn:!1,showRenameBtn:!1},callback:{onClick:function(e,t,a){return s.cNode=a,s.createNewBtns(a.models),s.showBtns(a),s.cNode&&(s.cNode.id,a.id),!1},onAsyncSuccess:function(e,t){if(s.cNode){var a=u.fn.zTree.getZTreeObj(t).getNodeByParam("id",s.cNode.id);s.showBtns(a)}else s.showBtns()},beforeDrop:function(e,t,a,n){var i=a;if(t[0].fromNode=t[0].getParentNode(),"inner"===n){if(1!==a.status)return f.toast.warning("无法将栏目移动到回收站里的栏目"),!1;if(2===t[0].status)return f.toast.warning("无法移动回收站里的栏目"),!1}else{if(t[0].channel===a.channel)return s.moveCh(e,t,a,n);i=a.getParentNode()}if(i){if(confirm("你真的要将栏目『"+t[0].name+"』移动到『"+i.name+"』吗?"))return s.moveCh(e,t,a,n)}else if(confirm("你真的要将栏目『"+t[0].name+"』变为顶级栏目吗?"))return s.moveCh(e,t,a,n);return!1}}}}})});